#### 为什么 STM32 的 Flash 地址要设置到 0x08000000 ?

**一、背景知识：**  

M3，M4 内核芯片上电复位后，要固定从 0x0000 0000 地址读取中断向量表，获取复位中断服务程序的入口地址后，进入复位中断服务程序，其中 0x0000 0000 是栈顶地址，0x0000 0004 存的是复位中断服务程序地址。  

![img](.assest/Note/234124srfdv7zwrjrfsf5m.png)  

![img](.assest/Note/234135stmfst4myr4lqvdt.png)  

ARM官方回复： https://developer.arm.com/documentation/ka001328/latest  

![img](.assest/Note/125344vl5vpw8rvwhw8hir.png)  **二、引出问题：**  

既然ARM规定了M3，M4内核要从地址 0x0000 0000 读取中断向量表，而 STM32 设置 Flash 地址到 0x0800 0000怎么办？ 

 STM32支持了个内存重映射功能，将地址 0x0800 0000 开始的内容重映射到首地址 0x0000 0000 中，这样就解决了从 0x0000 0000 读取中断向量表的问题。 

 图示，以STM32F407IGT6为例，0x0000 0000 和 0x0800 0000 开始的程序对比：  

![img](.assest/Note/O1CN0158f8Uk1gIY6tzVvhY_!!299314119.png)

   那么新的问题来：  

（1） 你怎么保证0x08000 0000首地址存的就是中断向量表，我们不可以随意设置吗？ 

 保证中断向量表存到 0x0800 0000，这个涉及到分散加载的一个小知识，以MDK为例，如果大家看 xxx.S 启动文件，里面通过AREA定义了一个名叫RESET的段，这段存的就是中断向量表。

```
; Vector Table Mapped to Address 0 at Reset
                AREA    RESET, DATA, READONLY
                EXPORT  __Vectors
                EXPORT  __Vectors_End
                EXPORT  __Vectors_Size
```

这个名字很重要，MDK对应的 xxx.sct 分散加载里面通过下面这句将这个RESET段放在了 0x0800 0000 优先存储。

```
; *************************************************************
; *** Scatter-Loading Description File generated by uVision ***
; *************************************************************

LR_IROM1 0x08000000 0x00200000  {    ; load region size_region
  ER_IROM1 0x08000000 0x00200000  {  ; load address = execution address
   *.o (RESET, +First)
   *(InRoot$Sections)
   .ANY (+RO)
   .ANY (+XO)
  }
  RW_IRAM2 0x24000000 0x00080000  {  ; RW data
   .ANY (+RW +ZI)
  }
}
```

这样我们就解决了 0x0800 0000 首地址存储中断向量表，一旦程序开始运行后，我们就可以随意设置中断向量表的位置了。比如想将中断向量表存到内部SRAM，我们就可以操作寄存器SCB->VTOR 重新安排，然后将 0x0800 0000 的内容复制到设置的地址内即可。  

（2） 既然设置到0x0800 0000这么麻烦，为什么不直接使用0x0000 0000？ 

 这是因为STM32不仅可以从内部Flash启动，还可以从系统存储器（可以实现串口ISP，USB DFU等程序下载方式，这个程序是ST固化好的程序代码）和从内部SRAM启动，我们将内部Flash安排到0x0000 0000显然是不行的。这样会导致系统存储器或者内部SRAM无法重映射到0x0000 0000了。  

![img](.assest/Note/002922oz1v5svsvpyh1h4q.png)   **三、**

**了解了M3和M4，M7是怎么个执行情况呢？**  

M7内核芯片比较灵活了，改变了固定从0x0000 0000地址读取中断向量表的问题，以 STM32H7 为例，可以从 0x0000 0000 到 0x3FFF 0000 所有地址进行启动。专门安排了个选项字节来配置。  

![img](.assest/Note/003243ny8r99y94tm99t48.png)  

H7里面没有重映射了，它的首地址0x0000 0000安排给ITCM RAM空间使用了。